name: Generate PR Patch

on:
  pull_request:
    types: [ready_for_review, labeled]

jobs:
  build-patch:
    # Only run when ready_for_review OR label == needs-review
    if: >
      github.event.action == 'ready_for_review' ||
      (github.event.action == 'labeled' && github.event.label.name == 'needs-review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: write

    steps:
      - name: Set PR context
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          echo "PATCH_URL=https://patch-diff.githubusercontent.com/raw/${{ github.repository }}/pull/${{ github.event.pull_request.number }}.patch" >> $GITHUB_ENV

      - name: Fetch patch
        run: |
          mkdir -p pr-reviews
          FNAME="pr-${PR_NUMBER}-${HEAD_SHA:0:7}-$(date +%Y%m%d-%H%M%S).patch"
          curl -fsSL "$PATCH_URL" -o "pr-reviews/$FNAME"
          echo "FNAME=$FNAME" >> $GITHUB_ENV
          test -s "pr-reviews/$FNAME" || (echo "Empty patch file" && exit 1)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ env.PR_NUMBER }}-patch
          path: pr-reviews/${{ env.FNAME }}
          if-no-files-found: error
          retention-days: 30

      - name: Comment with links
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const patchUrl = `https://patch-diff.githubusercontent.com/raw/${context.repo.owner}/${context.repo.repo}/pull/${pr.number}.patch`;
            const fname = process.env.FNAME;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: [
                `Patch ready: **${fname}**`,
                ``,
                `- Direct patch: ${patchUrl}`,
                `- Download artifact: see the “Artifacts” section of this workflow run.`,
              ].join('\n')
            });