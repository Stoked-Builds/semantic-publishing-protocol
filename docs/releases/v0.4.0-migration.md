
# Migration Guide — SPP v0.4.0

This guide helps implementers upgrade artifacts and registries to v0.4.

## 1) `signature` → `signatures[]`
**Before**
```json
{ "signature": { "signer": "old.example", "sig": "..." } }
```
**After**
```json
{ "signatures": [ { "signer": "registry.example.org", "key_id": "ed25519-2025-09", "sig": "..." } ] }
```

## 2) Add `provenance` fields
- Required: `registry_id` (domain), `adapter_id`, `collected_at`, `content_hash`.
- Optional: `publisher_did`, `adoption`, `snapshot_uri`.

**Example**
```json
{
  "provenance": {
    "mode": "adopted",
    "source_url": "https://example.com/post/123",
    "collected_at": "2025-09-27T12:34:56Z",
    "registry_id": "registry.example.org",
    "adapter_id": "youtube.core",
    "content_hash": "sha256:0123abcd...ef",
    "snapshot_uri": "https://cdn.example.org/snapshots/0123abcd"
  }
}
```

## 3) Signing (JCS)
- Canonicalise JSON with RFC 8785 (JCS).
- Sign payload: `{content_hash, registry_id, collected_at}` with Ed25519.
- Include signature under `signatures[]` (origin first).
- The origin registry’s signature MUST be the **first** element in `signatures[]`.

## 4) Peering requirements
- Implement `/api/peer/lookup?artifact_hash=...`.
- Enforce trust scoring: baseline 10; probation 14d; thresholds 70 / 30; daily cap ±15.
- Require corroboration (≥2 peers) for intermediate-trust registries.

## 5) Plugin isolation
- Run adapters in containers; read-only FS; caps on CPU/mem/time.
- Enforce egress allowlists; no direct DB/object-store creds.

## 6) Schema resolution
- If you use relative `$ref` (recommended), ensure your validator resolves local paths under `schemas/**`.

## 7) Checklist
- [ ] Schema updated to `signatures[]` and `provenance.*`
- [ ] Signature verification with JCS/Ed25519
- [ ] Peering trust scoring + corroboration flow
- [ ] `/api/peer/lookup` endpoint + errors
- [ ] Adapter containers + egress proxy
- [ ] DNS TXT or `/.well-known/spp` key proof live before peering

