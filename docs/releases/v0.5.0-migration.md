

# Migration Guide — v0.5.0 (Enrichment & Versioning)

This guide helps implementers adopt the Enrichment Layer without breaking existing producers/consumers.

## Producers (Publishers / Crawlers)
1. **Hash first:** compute `sha256(raw_bytes)` and use it to decide new versions.
2. **Write raw snapshot:** to `spp-raw` with `Content-Encoding: gzip`.
3. **Extract clean:** normalise text and write to `spp-clean`.
4. **Chunk:** 800–1200 tokens with 10–15% overlap; deterministic `chunkId`.
5. **Manifest:** publish per-version pointers and hashes.
6. **(Optional) Embeddings:** write vectors per chunk or per-version parquet.

## Registries
1. Add endpoints:
   - `GET /v1/artifacts/{id}/versions`
   - `GET /v1/artifacts/{id}/versions/{v}/manifest`
2. Store `first_seen` / `last_seen`; create versions only on hash change.
3. Keep idempotent writes; use UPSERTs and deterministic keys.

## Consumers (Agents / Indexers)
1. Prefer **latest** unless a version is specified.
2. Cache manifests; raw snapshots are immutable per hash.
3. Use `etag`/`lastModified` for cheap revalidation.

## Backfill Strategy
- You can enrich existing artifacts by re-fetching content, generating `raw/clean/chunks`, and writing version `1` manifests.
- For entries without accessible raw, start from clean text only; mark `raw` as `null`.

## Rollout Steps
- Phase 1: implement raw+clean+manifest.
- Phase 2: add chunks and diffs.
- Phase 3: add embeddings and query endpoints.

_No schema fields were removed; changes are additive._
